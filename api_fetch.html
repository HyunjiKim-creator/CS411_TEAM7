<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset = "UTF-8">
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0">
    <title>API Fetch</title>
    <style>
        #places > li > div {
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBj_JgUi97U0czCWUO6OccZxQahvBJe9Oo&libraries=places"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"
        integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous">
    </script>
</head>


<body>
    <h1>
        This is for city name to lon/lat, lon/lat + date to weather, lon/lat + preference to places
    </h1>

    <label for = "city">City name:</label>
    <input id = "city" type = "text" />

    <label for = "dateAhead">Date:</label>
    <input id = "dateAhead" type = "date" min=""/>

    <label for="preference">Type of place:</label>
    <select id="preference">
        <option value="bar">Bar</option>
        <option value="cafe">Cafe</option>
        <option value="museum">Museum</option>
        <option value="park">Park</option>
        <option value="restaurant">Restaurant</option>
        <option value="shopping_mall">Shopping Mall</option>
        <option value="supermarket">Supermarket</option>
    </select>

    <button id = "submit">Submit</button>

    <p id = "output"></p>
    <p id = "weather"></p>
    <div id="map" style="height: 400px;"></div>
    <ul id="places"></ul>

    <script>
        var apiKey = "98e68699085dbddbfb65f34ceb0906d8";
        var map, service, markers = [];

        function initialize(lat, lon, type) {
            var location = new google.maps.LatLng(lat, lon);
            map = new google.maps.Map(document.getElementById('map'), { center: location, zoom: 15 });
            var request = { location: location, radius: '500', types: [type] };
            service = new google.maps.places.PlacesService(map);
            service.nearbySearch(request, callback);
        }

        function callback(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                $("#places").empty();
                markers.forEach(function(marker) { marker.setMap(null); });
                markers = [];
                for (var i = 0; i < results.length; i++) {
                    createMarker(results[i]);
                    addToList(results[i]);
                }
            }
        }

        function createMarker(place) {
            var marker = new google.maps.Marker({ map: map, position: place.geometry.location });
            markers.push(marker);
        }

        function addToList(place) {
            var ul = document.getElementById("places");
            var li = document.createElement("li");

            var placeName = document.createElement("div");
            placeName.textContent = place.name;
            li.appendChild(placeName);

            var rating = document.createElement("ul");
            var ratingItem = document.createElement("li");
            ratingItem.textContent = 'Rating: ' + (place.rating || 'No rating');
            rating.appendChild(ratingItem);
            li.appendChild(rating);

            var address = document.createElement("ul");
            var addressItem = document.createElement("li");
            addressItem.textContent = 'Address: ' + (place.vicinity || 'No address');
            address.appendChild(addressItem);
            li.appendChild(address);

            ul.appendChild(li);
        }

        $(document).ready(function() {
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();
            today = yyyy + '-' + mm + '-' + dd;
            document.getElementById("dateAhead").min = today;

            $("#submit").click(function () {
                var city = $("#city").val();
                var dateAhead = new Date($("#dateAhead").val());
                var todayDate = new Date(today);
                var diffTime = Math.abs(dateAhead - todayDate);
                var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                $.ajax({
                    method: "GET",
                    url: `http://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${apiKey}`,
                })
                    .done(function (data) {
                        if (data.length > 0) {
                            var lat = data[0].lat;
                            var lon = data[0].lon;
                            var type = $("#preference").val();
                            $("#output").text(`Latitude: ${lat}, Longitude: ${lon}`);
                            initialize(lat, lon, type);
                            $.ajax({
                                method: "GET",
                                url: `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=current,minutely,hourly,alerts&appid=${apiKey}`,
                            })
                                .done(function (weatherData) {
                                    var forecastData = weatherData.daily;
                                    if (forecastData.length > diffDays) {
                                        var tempK = forecastData[diffDays - 1].temp.day;
                                        var tempC = tempK - 273.15;
                                        var tempF = tempC * 9 / 5 + 32;

                                        dateAhead.setDate(dateAhead.getDate() + 1);
                                        $("#weather").text(`The temperature on ${dateAhead.toLocaleDateString()} will be ${tempC.toFixed(2)}°C or ${tempF.toFixed(2)}°F`);
                                    } else {
                                        $("#weather").text("Forecast data for that date is not available");
                                    }
                                });
                        } else {
                            $("#output").text("Invalid city name");
                        }
                    });
            });
        });
    </script>

</body>

</html>
